<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØºÙŠØ± Ù…ØªØµÙ„</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border-right: 4px solid var(--primary);
        }
        .status-indicator {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .status-success { background: var(--success); color: white; }
        .status-error { background: var(--danger); color: white; }
        .status-warning { background: var(--warning); color: white; }
        .log-box {
            background: #1e1e1e;
            color: #00ff00;
            padding: 1rem;
            border-radius: var(--radius);
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid #333;
        }
        .test-button {
            margin: 0.5rem;
            padding: 1rem 2rem;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØºÙŠØ± Ù…ØªØµÙ„</h1>
        
        <!-- Online Status -->
        <div class="test-section">
            <h2>ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</h2>
            <div id="networkStatus"></div>
        </div>
        
        <!-- Service Worker Status -->
        <div class="test-section">
            <h2>âš™ï¸ Ø­Ø§Ù„Ø© Service Worker</h2>
            <div id="swStatus"></div>
            <button onclick="registerSW()" class="btn test-button">ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Service Worker</button>
            <button onclick="unregisterSW()" class="btn btn-secondary test-button">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        </div>
        
        <!-- Cache Status -->
        <div class="test-section">
            <h2>ğŸ’¾ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª</h2>
            <div id="cacheStatus"></div>
            <button onclick="checkCache()" class="btn test-button">ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©</button>
            <button onclick="clearCache()" class="btn btn-secondary test-button">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>
        </div>
        
        <!-- Database Status -->
        <div class="test-section">
            <h2>ğŸ—„ï¸ Ø­Ø§Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            <div id="dbStatus"></div>
            <button onclick="testDB()" class="btn test-button">âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</button>
        </div>
        
        <!-- Console Log -->
        <div class="test-section">
            <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
            <div id="logBox" class="log-box"></div>
            <button onclick="clearLog()" class="btn btn-secondary test-button">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
        
        <!-- Test Instructions -->
        <div class="test-section" style="border-right-color: var(--warning);">
            <h2>ğŸ“‹ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <ol style="text-align: right; padding-right: 2rem;">
                <li>ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Service Worker (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† "Ù†Ø´Ø·")</li>
                <li>Ø§Ø¶ØºØ· "ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©" - ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª</li>
                <li>Ø§ÙØµÙ„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (Airplane Mode Ø£Ùˆ WiFi Off)</li>
                <li>Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (F5)</li>
                <li>Ø¥Ø°Ø§ Ø¹Ù…Ù„Øª Ø§Ù„ØµÙØ­Ø© = âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØºÙŠØ± Ù…ØªØµÙ„ ÙŠØ¹Ù…Ù„!</li>
                <li>Ø¥Ø°Ø§ Ø¸Ù‡Ø± 404 = âŒ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø©</li>
            </ol>
        </div>
        
        <div class="text-center mt-3">
            <a href="index.html" class="btn btn-primary">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>
    </div>
    
    <script src="js/db.js"></script>
    <script>
        const log = (message, type = 'info') => {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString('ar-TN');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${time}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        };
        
        const clearLog = () => {
            document.getElementById('logBox').innerHTML = '';
        };
        
        // Check network status
        const checkNetwork = () => {
            const status = document.getElementById('networkStatus');
            if (navigator.onLine) {
                status.innerHTML = '<span class="status-indicator status-success">ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</span>';
                log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù…ØªØ§Ø­');
            } else {
                status.innerHTML = '<span class="status-indicator status-error">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</span>';
                log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            }
        };
        
        // Check Service Worker
        const checkServiceWorker = async () => {
            const status = document.getElementById('swStatus');
            
            if (!('serviceWorker' in navigator)) {
                status.innerHTML = '<span class="status-indicator status-error">âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</span>';
                log('âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                
                if (registration) {
                    const state = registration.active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                    const scope = registration.scope;
                    status.innerHTML = `
                        <span class="status-indicator status-success">âœ… Ù…Ø³Ø¬Ù„ Ùˆ${state}</span>
                        <p style="font-size: 0.9rem; color: var(--gray-600); margin-top: 0.5rem;">
                            Scope: ${scope}
                        </p>
                    `;
                    log(`âœ… Service Worker Ù…Ø³Ø¬Ù„: ${scope}`);
                    
                    if (registration.waiting) {
                        log('âš ï¸ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                    }
                } else {
                    status.innerHTML = '<span class="status-indicator status-warning">âš ï¸ ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>';
                    log('âš ï¸ Service Worker ØºÙŠØ± Ù…Ø³Ø¬Ù„');
                }
            } catch (error) {
                status.innerHTML = '<span class="status-indicator status-error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ</span>';
                log(`âŒ Ø®Ø·Ø£: ${error.message}`);
            }
        };
        
        // Register Service Worker
        const registerSW = async () => {
            if (!('serviceWorker' in navigator)) {
                log('âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                return;
            }
            
            try {
                log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker...');
                const registration = await navigator.serviceWorker.register('service-worker.js');
                log(`âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${registration.scope}`);
                
                // Wait for activation
                await navigator.serviceWorker.ready;
                log('âœ… Service Worker Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
                
                checkServiceWorker();
            } catch (error) {
                log(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${error.message}`);
            }
        };
        
        // Unregister Service Worker
        const unregisterSW = async () => {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.unregister();
                    log('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Service Worker');
                    checkServiceWorker();
                } else {
                    log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Service Worker Ù…Ø³Ø¬Ù„');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`);
            }
        };
        
        // Check cache
        const checkCache = async () => {
            const status = document.getElementById('cacheStatus');
            
            if (!('caches' in window)) {
                status.innerHTML = '<span class="status-indicator status-error">âŒ Cache API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</span>';
                log('âŒ Cache API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                return;
            }
            
            try {
                log('ğŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª...');
                const cacheNames = await caches.keys();
                
                if (cacheNames.length === 0) {
                    status.innerHTML = '<span class="status-indicator status-warning">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø®Ø²Ù†Ø©</span>';
                    log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª');
                    return;
                }
                
                let totalFiles = 0;
                let html = '<div style="margin-top: 1rem;">';
                
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const requests = await cache.keys();
                    totalFiles += requests.length;
                    
                    html += `<details style="margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: var(--radius);">`;
                    html += `<summary style="cursor: pointer; font-weight: bold;">ğŸ“¦ ${cacheName} (${requests.length} Ù…Ù„Ù)</summary>`;
                    html += '<ul style="margin: 0.5rem 0; padding-right: 2rem; font-size: 0.85rem;">';
                    
                    for (const request of requests) {
                        const url = new URL(request.url);
                        html += `<li>${url.pathname}</li>`;
                        log(`   - ${url.pathname}`);
                    }
                    
                    html += '</ul></details>';
                }
                
                html += '</div>';
                status.innerHTML = `<span class="status-indicator status-success">âœ… ${totalFiles} Ù…Ù„Ù Ù…Ø®Ø²Ù†</span>` + html;
                log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${totalFiles} Ù…Ù„Ù ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†`);
                
            } catch (error) {
                status.innerHTML = '<span class="status-indicator status-error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ</span>';
                log(`âŒ Ø®Ø·Ø£: ${error.message}`);
            }
        };
        
        // Clear cache
        const clearCache = async () => {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ')) return;
            
            try {
                log('ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª...');
                const cacheNames = await caches.keys();
                
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    log(`âœ… ØªÙ… Ù…Ø³Ø­: ${cacheName}`);
                }
                
                log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©');
                checkCache();
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`);
            }
        };
        
        // Test database
        const testDB = async () => {
            const status = document.getElementById('dbStatus');
            
            try {
                log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                await db.init();
                
                const groups = await db.getAllGroups();
                const students = await db.getAllStudents();
                
                status.innerHTML = `
                    <span class="status-indicator status-success">âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¹Ù…Ù„</span>
                    <p style="margin-top: 0.5rem;">
                        Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${groups.length} | Ø§Ù„Ø·Ù„Ø§Ø¨: ${students.length}
                    </p>
                `;
                
                log(`âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¹Ù…Ù„`);
                log(`   - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${groups.length}`);
                log(`   - Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${students.length}`);
                
            } catch (error) {
                status.innerHTML = '<span class="status-indicator status-error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</span>';
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            }
        };
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ...');
            checkNetwork();
            checkServiceWorker();
            checkCache();
            testDB();
        });
        
        window.addEventListener('online', () => {
            log('ğŸŸ¢ Ø¹Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            checkNetwork();
        });
        
        window.addEventListener('offline', () => {
            log('ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            checkNetwork();
        });
    </script>
</body>
</html>
